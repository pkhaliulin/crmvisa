<template>
  <div class="max-w-3xl mx-auto space-y-8">
    <div>
      <h1 class="text-xl font-bold text-gray-900">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞</h1>
      <p class="text-sm text-gray-500 mt-1">–ü—Ä–æ—Ñ–∏–ª—å, –∫–æ–º–∞–Ω–¥–∞ –∏ —Ä–∞–±–æ—á–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
    </div>

    <div v-if="loading" class="text-center py-12 text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <template v-else>
      <!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <section class="bg-white rounded-xl border border-gray-200 p-6 space-y-4">
        <h2 class="font-semibold text-gray-700 text-sm uppercase tracking-wide">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞</label>
          <textarea v-model="form.description" rows="4"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –∞–≥–µ–Ω—Ç—Å—Ç–≤–µ..."></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">–°–∞–π—Ç</label>
            <input v-model="form.website_url" type="url"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="https://example.com" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">–ì–æ—Ä–æ–¥</label>
            <input v-model="form.city" type="text"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="–¢–∞—à–∫–µ–Ω—Ç" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã (–ª–µ—Ç)</label>
            <input v-model.number="form.experience_years" type="number" min="0" max="100"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–ê–¥—Ä–µ—Å</label>
          <input v-model="form.address" type="text"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="–£–ª. –ê–º–∏—Ä–∞ –¢–∏–º—É—Ä–∞, 1" />
        </div>
      </section>

      <!-- –ö–æ–º–∞–Ω–¥–∞ -->
      <section class="bg-white rounded-xl border border-gray-200 p-6 space-y-4">
        <h2 class="font-semibold text-gray-700 text-sm uppercase tracking-wide">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π</h2>

        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <div>
            <p class="text-sm font-medium text-gray-700">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –≤–∏–¥—è—Ç –≤—Å–µ –∑–∞—è–≤–∫–∏</p>
            <p class="text-xs text-gray-500 mt-0.5">–ï—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ, –∫–∞–∂–¥—ã–π –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏</p>
          </div>
          <button @click="form.managers_see_all_cases = !form.managers_see_all_cases"
            :class="['relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none',
              form.managers_see_all_cases ? 'bg-blue-600' : 'bg-gray-300']">
            <span :class="['inline-block h-4 w-4 transform rounded-full bg-white transition-transform',
              form.managers_see_all_cases ? 'translate-x-6' : 'translate-x-1']" />
          </button>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–ê–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∏–¥–æ–≤</label>
          <select v-model="form.lead_assignment_mode"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="manual">–í—Ä—É—á–Ω—É—é</option>
            <option value="round_robin">–ü–æ –æ—á–µ—Ä–µ–¥–∏ (Round Robin)</option>
            <option value="by_workload">–ü–æ –∑–∞–≥—Ä—É–∑–∫–µ (–º–∏–Ω–∏–º—É–º –∞–∫—Ç–∏–≤–Ω—ã—Ö)</option>
            <option value="by_country">–ü–æ —Å—Ç—Ä–∞–Ω–µ (–æ–ø—ã—Ç —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º)</option>
          </select>
        </div>
      </section>

      <!-- –°—Ç—Ä–∞–Ω—ã —Ä–∞–±–æ—Ç—ã -->
      <section class="bg-white rounded-xl border border-gray-200 p-6 space-y-4">
        <h2 class="font-semibold text-gray-700 text-sm uppercase tracking-wide">–†–∞–±–æ—á–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>

        <div class="grid grid-cols-3 gap-3">
          <label v-for="c in allCountries" :key="c.code"
            class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" :value="c.code" v-model="selectedCountries"
              class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
            <span class="text-sm text-gray-700">{{ c.flag }} {{ c.name }}</span>
          </label>
        </div>
      </section>

      <div class="flex justify-end">
        <button @click="save" :disabled="saving"
          class="px-6 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors">
          {{ saving ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' }}
        </button>
      </div>

      <p v-if="successMsg" class="text-sm text-green-600 text-right">{{ successMsg }}</p>
      <p v-if="errorMsg" class="text-sm text-red-600 text-right">{{ errorMsg }}</p>
    </template>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import api from '@/api/index';

const loading = ref(true);
const saving  = ref(false);
const successMsg = ref('');
const errorMsg   = ref('');

const form = ref({
  description: '',
  website_url: '',
  city: '',
  experience_years: null,
  address: '',
  managers_see_all_cases: false,
  lead_assignment_mode: 'manual',
});

const selectedCountries = ref([]);

const allCountries = [
  { code: 'US', name: '–°–®–ê',          flag: 'üá∫üá∏' },
  { code: 'DE', name: '–ì–µ—Ä–º–∞–Ω–∏—è',     flag: 'üá©üá™' },
  { code: 'FR', name: '–§—Ä–∞–Ω—Ü–∏—è',      flag: 'üá´üá∑' },
  { code: 'GB', name: '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', flag: 'üá¨üáß' },
  { code: 'TR', name: '–¢—É—Ä—Ü–∏—è',       flag: 'üáπüá∑' },
  { code: 'AE', name: '–û–ê–≠',          flag: 'üá¶üá™' },
  { code: 'KZ', name: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',    flag: 'üá∞üáø' },
  { code: 'RU', name: '–†–æ—Å—Å–∏—è',       flag: 'üá∑üá∫' },
  { code: 'CN', name: '–ö–∏—Ç–∞–π',        flag: 'üá®üá≥' },
  { code: 'IT', name: '–ò—Ç–∞–ª–∏—è',       flag: 'üáÆüáπ' },
  { code: 'ES', name: '–ò—Å–ø–∞–Ω–∏—è',      flag: 'üá™üá∏' },
];

onMounted(async () => {
  try {
    const res = await api.get('/agency/settings');
    const data = res.data.data;
    Object.keys(form.value).forEach(key => {
      if (data[key] !== undefined && data[key] !== null) form.value[key] = data[key];
    });
    selectedCountries.value = (data.work_countries || [])
      .filter(c => c.is_active)
      .map(c => c.country_code);
  } catch {
    // ignore
  } finally {
    loading.value = false;
  }
});

async function save() {
  saving.value = true;
  successMsg.value = '';
  errorMsg.value = '';
  try {
    await api.patch('/agency/settings', form.value);

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ä–∞–±–æ—á–∏–µ —Å—Ç—Ä–∞–Ω—ã
    const currentRes = await api.get('/agency/work-countries');
    const current = (currentRes.data.data || []).map(c => c.country_code);

    const toAdd = selectedCountries.value.filter(c => !current.includes(c));
    const toRemove = current.filter(c => !selectedCountries.value.includes(c));

    await Promise.all([
      ...toAdd.map(c => api.post('/agency/work-countries', { country_code: c })),
      ...toRemove.map(c => api.delete(`/agency/work-countries/${c}`)),
    ]);

    successMsg.value = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
  } catch (e) {
    errorMsg.value = e.response?.data?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
  } finally {
    saving.value = false;
  }
}
</script>
