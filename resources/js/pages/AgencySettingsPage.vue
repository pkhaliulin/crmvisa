<template>
  <div class="max-w-3xl mx-auto space-y-8">
    <div>
      <h1 class="text-xl font-bold text-gray-900">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞</h1>
      <p class="text-sm text-gray-500 mt-1">–ü—Ä–æ—Ñ–∏–ª—å, –∫–æ–º–∞–Ω–¥–∞ –∏ —Ä–∞–±–æ—á–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
    </div>

    <div v-if="loading" class="text-center py-12 text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <template v-else>
      <!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <section class="bg-white rounded-xl border border-gray-200 p-6 space-y-4">
        <h2 class="font-semibold text-gray-700 text-sm uppercase tracking-wide">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>

        <AppTextarea
          v-model="form.description"
          label="–û–ø–∏—Å–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞"
          placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –∞–≥–µ–Ω—Ç—Å—Ç–≤–µ: —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –æ–ø—ã—Ç, –∫–ª—é—á–µ–≤—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
          :maxlength="1000"
          :rows="4"
          hint="–û–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ"
        />

        <div class="grid grid-cols-2 gap-4">
          <AppInput
            v-model="form.website_url"
            label="–°–∞–π—Ç"
            type="url"
            placeholder="https://example.com"
            :maxlength="200"
          />
          <AppInput
            v-model="form.city"
            label="–ì–æ—Ä–æ–¥"
            type="text"
            placeholder="–¢–∞—à–∫–µ–Ω—Ç"
            :maxlength="80"
          />
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã (–ª–µ—Ç)</label>
            <input v-model.number="form.experience_years" type="number" min="0" max="100"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors" />
          </div>
        </div>

        <AppInput
          v-model="form.address"
          label="–ê–¥—Ä–µ—Å"
          type="text"
          placeholder="–£–ª. –ê–º–∏—Ä–∞ –¢–∏–º—É—Ä–∞, 1"
          :maxlength="200"
        />
      </section>

      <!-- –ö–æ–º–∞–Ω–¥–∞ -->
      <section class="bg-white rounded-xl border border-gray-200 p-6 space-y-4">
        <h2 class="font-semibold text-gray-700 text-sm uppercase tracking-wide">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π</h2>

        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-100">
          <div>
            <p class="text-sm font-medium text-gray-700">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –≤–∏–¥—è—Ç –≤—Å–µ –∑–∞—è–≤–∫–∏</p>
            <p class="text-xs text-gray-500 mt-0.5">–ï—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ ‚Äî –∫–∞–∂–¥—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏</p>
          </div>
          <button @click="form.managers_see_all_cases = !form.managers_see_all_cases"
            :class="['relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1',
              form.managers_see_all_cases ? 'bg-blue-600' : 'bg-gray-300']">
            <span :class="['inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform',
              form.managers_see_all_cases ? 'translate-x-6' : 'translate-x-1']" />
          </button>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">–ê–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∏–¥–æ–≤</label>
          <select v-model="form.lead_assignment_mode"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors">
            <option value="manual">–í—Ä—É—á–Ω—É—é (–º–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é)</option>
            <option value="round_robin">–ü–æ –æ—á–µ—Ä–µ–¥–∏ (Round Robin ‚Äî —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ –∫—Ä—É–≥—É)</option>
            <option value="by_workload">–ü–æ –∑–∞–≥—Ä—É–∑–∫–µ (–º–µ–Ω–µ–¥–∂–µ—Ä —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º —á–∏—Å–ª–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫)</option>
            <option value="by_country">–ü–æ —Å—Ç—Ä–∞–Ω–µ (–º–µ–Ω–µ–¥–∂–µ—Ä —Å –æ–ø—ã—Ç–æ–º –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é)</option>
          </select>
          <p class="text-xs text-gray-400 mt-1">–í–ª–∏—è–µ—Ç –Ω–∞ —Ç–æ, –∫–∞–∫ –Ω–æ–≤—ã–µ –ª–∏–¥—ã —Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º</p>
        </div>
      </section>

      <!-- –°—Ç—Ä–∞–Ω—ã —Ä–∞–±–æ—Ç—ã -->
      <section class="bg-white rounded-xl border border-gray-200 p-6 space-y-4">
        <div>
          <h2 class="font-semibold text-gray-700 text-sm uppercase tracking-wide">–†–∞–±–æ—á–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
          <p class="text-xs text-gray-400 mt-1">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—ã, —Å –≤–∏–∑–∞–º–∏ –∫–æ—Ç–æ—Ä—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–∞—à–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ</p>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <label v-for="c in allCountries" :key="c.code"
            :class="[
              'flex items-center gap-2 cursor-pointer p-2 rounded-lg border transition-colors',
              selectedCountries.includes(c.code)
                ? 'border-blue-300 bg-blue-50'
                : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50',
            ]">
            <input type="checkbox" :value="c.code" v-model="selectedCountries"
              class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
            <span class="text-sm text-gray-700">{{ c.flag }} {{ c.name }}</span>
          </label>
        </div>

        <p class="text-xs text-gray-400">
          –í—ã–±—Ä–∞–Ω–æ: {{ selectedCountries.length }} –∏–∑ {{ allCountries.length }}
        </p>
      </section>

      <div class="flex items-center justify-between">
        <div>
          <p v-if="successMsg" class="text-sm text-green-600 font-medium">{{ successMsg }}</p>
          <p v-if="errorMsg" class="text-sm text-red-600">{{ errorMsg }}</p>
        </div>
        <button @click="save" :disabled="saving"
          class="px-6 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors">
          {{ saving ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' }}
        </button>
      </div>
    </template>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import api from '@/api/index';
import AppInput from '@/components/AppInput.vue';
import AppTextarea from '@/components/AppTextarea.vue';

const loading    = ref(true);
const saving     = ref(false);
const successMsg = ref('');
const errorMsg   = ref('');

const form = ref({
  description: '',
  website_url: '',
  city: '',
  experience_years: null,
  address: '',
  managers_see_all_cases: false,
  lead_assignment_mode: 'manual',
});

const selectedCountries = ref([]);

const allCountries = [
  { code: 'DE', name: '–ì–µ—Ä–º–∞–Ω–∏—è',      flag: 'üá©üá™' },
  { code: 'FR', name: '–§—Ä–∞–Ω—Ü–∏—è',       flag: 'üá´üá∑' },
  { code: 'IT', name: '–ò—Ç–∞–ª–∏—è',        flag: 'üáÆüáπ' },
  { code: 'ES', name: '–ò—Å–ø–∞–Ω–∏—è',       flag: 'üá™üá∏' },
  { code: 'GB', name: '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è',flag: 'üá¨üáß' },
  { code: 'US', name: '–°–®–ê',           flag: 'üá∫üá∏' },
  { code: 'CZ', name: '–ß–µ—Ö–∏—è',         flag: 'üá®üáø' },
  { code: 'PL', name: '–ü–æ–ª—å—à–∞',        flag: 'üáµüá±' },
  { code: 'TR', name: '–¢—É—Ä—Ü–∏—è',        flag: 'üáπüá∑' },
  { code: 'AE', name: '–û–ê–≠',           flag: 'üá¶üá™' },
  { code: 'KZ', name: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',     flag: 'üá∞üáø' },
  { code: 'RU', name: '–†–æ—Å—Å–∏—è',        flag: 'üá∑üá∫' },
  { code: 'CN', name: '–ö–∏—Ç–∞–π',         flag: 'üá®üá≥' },
  { code: 'KR', name: '–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è',   flag: 'üá∞üá∑' },
  { code: 'CA', name: '–ö–∞–Ω–∞–¥–∞',        flag: 'üá®üá¶' },
];

onMounted(async () => {
  try {
    const res = await api.get('/agency/settings');
    const data = res.data.data;
    Object.keys(form.value).forEach(key => {
      if (data[key] !== undefined && data[key] !== null) form.value[key] = data[key];
    });
    selectedCountries.value = (data.work_countries || [])
      .filter(c => c.is_active)
      .map(c => c.country_code);
  } catch {
    // ignore
  } finally {
    loading.value = false;
  }
});

async function save() {
  saving.value = true;
  successMsg.value = '';
  errorMsg.value = '';
  try {
    await api.patch('/agency/settings', form.value);

    const currentRes = await api.get('/agency/work-countries');
    const current = (currentRes.data.data || []).map(c => c.country_code);

    const toAdd    = selectedCountries.value.filter(c => !current.includes(c));
    const toRemove = current.filter(c => !selectedCountries.value.includes(c));

    await Promise.all([
      ...toAdd.map(c => api.post('/agency/work-countries', { country_code: c })),
      ...toRemove.map(c => api.delete(`/agency/work-countries/${c}`)),
    ]);

    successMsg.value = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
    setTimeout(() => { successMsg.value = ''; }, 3000);
  } catch (e) {
    errorMsg.value = e.response?.data?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
  } finally {
    saving.value = false;
  }
}
</script>
